window.m=window.m||{},define(["jquery","carousel","knockout","knockoututils","json2.min","bootstrap","mobilebase"],function(e,o,t){function r(){var o=this;o.order={jqFormCartList:e("#form_cartList"),jqFormOrderInfo:e("#form_orderInfo"),od_id:t.observable(),odata:t.observableArray(),myorder:new m.Odata,member:new m.setMember,coupons:t.observableArray(),coupon:new m.setCoupon,isBuy:t.observable(!1),init:function(){e("#checkbox_selectAllCartItem").change(function(){{var t=this.checked;e("#list_cart .item_cart")}e.map(o.order.odata(),function(e){e.it_checked(t)})}),this.jqFormCartList.submit(function(){{var t=e("#view_orderInfo");t.prev()}return o.order.hasCheckedItem()===!0?(o.order.isBuy(!0),o.order.showInfo(),e(document).scrollTop(0)):alert("선택된 상품이 없습니다."),!1}),this.jqFormOrderInfo.parent().hide(),e("#list_cart").tooltip({trigger:"manual"}).on("shown.bs.tooltip",function(){m.timer(2e3,function(){e("#list_cart").tooltip("hide")})}),e("#button_orderInfo_cancel").click(function(){m.viewSlider.prev()}),this.jqFormOrderInfo.submit(function(){var o=e(this),t=o.find("input[type='email']"),r=o.find("*[required]"),n=o.find("*[data-required]"),i=!0,d=!1,a=/^([0-9a-zA-Z_-]+)@([0-9a-zA-Z_-]+)(\.[0-9a-zA-Z_-]+){1,2}$/,c="",s=null;if(n.each(function(){if(i!==!1){var o=e(this).find("input[type='radio']"),t=!1,r="";o.each(function(){t=t||this.checked}),t===!1&&(i=!1,d=!0,r=e(this).prev().text(),c=r+" 항목을 체크하여 주십시오.",s=e(this))}}),r.each(function(){if(i!==!1){var o=e(this),t="";""===o.val()&&(i=!1,t=o.parentsUntil(".form-group").parent().find("label").text(),(void 0===t||""===t)&&(t=o.attr("placeholder"),(void 0===t||""===t)&&(t=o.parentsUntil("[data-placeholder]").parent().data("placeholder"))),c=t+" 항목을 정확히 기재해 주십시오.",s=o)}}),t.each(function(){if(i!==!1){var o=e(this);return a.test(o.val())===!1?(i=!1,c="이메일을 정확히 기재해 주십시오.",s=o,void 0):void 0}}),i===!0){var _=e("input[name='od_settle_use']:checked");1!==_.length&&(i=!1,c="결제방법을 선택하여 주십시오.",s=e("input[name='od_settle_use']").eq(0))}return i===!1&&(alert(c),d===!1&&s.focus()),"sd_yotimer"===m.mb_id&&alert("isOK: "+i),i}),this.totalDiscount=t.computed(function(){try{var t=e.tryParseInt(o.order.myorder.od_coupon()),r=e.tryParseInt(o.order.myorder.od_cash()),n=0,i=e.tryParseInt(o.order.myorder.od_enuri());return t+r+n+i}catch(d){return 0}}),this.totalPrice=t.computed(function(){try{for(var t=o.order.odata(),r=t.length,n=0,i=0;r>i;i++)"배송비"!==t[i].it_name()&&(console.log(t[i].it_checked()),t[i].it_checked()===!0&&(n+=e.tryParseInt(t[i].it_settle_price())));return n}catch(d){return 0}}),this.delivery=t.computed(function(){try{return o.order.odata()[0].od_delivery()}catch(e){return 0}}),this.excludingShippingPrice=t.computed(function(){try{return o.order.totalPrice()+o.order.delivery()}catch(e){return 0}}),this.itemCount=t.computed(function(){try{for(var e=0,t=o.order.odata(),r=t.length,n=0;r>n;n++)t[n].it_checked()===!0&&e++;return e}catch(i){return 0}}),this.totalSettlePrice=t.computed(function(){try{var e=o.order.totalPrice(),t=o.order.totalDiscount(),r=o.order.delivery();return e-t+r}catch(n){return 0}}),this.orderName=t.computed(function(){try{return o.order.odata()[0].od_name()}catch(e){return"상품없음"}}),this.totalItemName=t.computed(function(){try{var e=o.order.odata(),t=e[0].it_name(),r=e.length;return r>1?t+" (외 "+(r-1)+"종)":t}catch(n){return"상품없음"}}),this.orderCouponUse=t.computed(function(){try{var e=o.order.coupon.id();if(void 0!==e&&""!==e)return 1}catch(t){}return 0})},isOverDiscount:function(o,t){if(void 0===o||void 0===t)return!1;var r=!1,n="",i=this.totalDiscount(),d=parseInt(t),a=e.tryParseInt(this.totalPrice());return"coupon"===o&&(n=e.tryParseInt(this.coupon.cp_price())),"cash"===o&&(n=e.tryParseInt(this.myorder.od_cash())),r=0>a-(i-n+d)},hasCheckedItem:function(){for(var e=this.odata(),o=e.length,t=0,r=0;o>r;r++)e[r].it_checked()===!0&&t++;return t>0},itemCollapse:function(o,t){try{var r=e(t.target),n=r,i=r.parentsUntil(".collapsible").parent();n.toggleClass("glyphicon-chevron-down"),n.toggleClass("glyphicon-chevron-up"),i.find(".collapsible-body").toggle(0,function(){}),i.find(".sub-item.badge").text(i.find(".list-group-item").length)}catch(d){}},copyItemsToOrderInfo:function(){var e=m.serializeMapByCheckedItem(this.jqFormCartList,["it_id","it_qty","it_settle_price"],",","ca_id",".item_cart");console.log(e),this.jqFormOrderInfo.find("[name='it_id']").val(e.it_id),this.jqFormOrderInfo.find("[name='it_qty']").val(e.it_qty),this.jqFormOrderInfo.find("[name='it_settle_price']").val(e.it_settle_price)},initCouponInfo:function(){void 0!==o.order.myMemberInfo&&e.getJSON("/popkon/ajax_get_coupon_list_json.php",{mb_id:o.order.myMemberInfo.mb_id},function(t){o.order.coupons.removeAll(),e.map(t,function(e,t){var r=new m.setCoupon(e,t);o.order.coupons.push(r)})})},removeCoupon:function(){this.coupon.set(),this.myorder.od_coupon(0),this.myorder.od_coupon_id(0),this.myorder.od_coupon_use(0)},changeCoupon:function(o,t){if(void 0!==o)try{var r=t.target,n=(e(r),r.selectedIndex-1);console.log("selectedIndex:"+n+1),0>n?o.removeCoupon():(console.log(o.coupons()[n].id()),console.log(o.coupons()[n].cp_id()),e.post("/mobile/mb/ajax_order_coupon_comp_stest.php",{id:o.coupons()[n].id(),cp_id:o.coupons()[n].cp_id()},function(e){if("n"===e)return m.toast("적용할 수 없는 쿠폰입니다."),o.removeCoupon(),void 0;var t=e.split(":"),r=o.coupons()[n],i=parseInt(t[1]);o.isOverDiscount("coupon",i)===!0?(alert("총 할인금액이 결제 금액보다 큽니다."),o.removeCoupon()):(m.toast("쿠폰이 적용 되었습니다."),o.coupon.set(r),o.myorder.od_coupon(i),o.myorder.od_coupon_id(o.coupon.id),o.myorder.od_coupon_use(o.coupon.cp_type))}))}catch(i){}},applyCash:function(t,r,n){if(void 0!==t)try{{var i=e.tryParseInt(t.member.mb_cash()),d=e.tryParseInt(t.member.dsp_cash()),a=e.tryParseInt(t.totalDiscount());e.tryParseInt(t.myorder.od_total_price())}if(5e3>i)return alert("적립금은 5000원 이상부터 사용 가능합니다."),void 0;if(0===i)return alert("사용할 적립금이 없습니다."),void 0;if(d>i)return alert("현재 보유한 적립금보다 많습니다."),t.member.dsp_cash(i),void 0;if(5e3>d)return alert("적립금은 5000원 이상 부터 사용 가능합니다."),void 0;if(t.isOverDiscount("cash",d)===!0)return alert("적용할 적립금이 결제 금액보다 많습니다."),void 0;o.order.sendDiscountInfo(o.order.od_id(),n?t.myorder.od_cash():t.member.dsp_cash(),0,t.myorder.od_total_price(),a+d)}catch(c){}},sendDiscountInfo:function(t,r,n,i,d){0!==o.order.odata().length&&e.post("/mobile/mb/ajax_order_cash_comp.php",{od_id:t,od_cash:r,od_ahn:n,total_price:i,dscountval:d},function(e){e="1";var t=parseInt(e);100!==t&&(o.order.myorder.od_cash(r),m.toast("금액을 적용 하였습니다."))})},initMemberInfo:function(){e.getJSON("/bbs/member_json.php",function(e){o.order.myMemberInfo=e,o.order.applyMemberInfo(!0),o.order.initCouponInfo()})},chooseAddress:function(t,r){try{var n=e(r.target);"INPUT"!==n.prop("tagName")&&(n=n.find("input")),"1"===n.val()?o.order.applyMemberInfo():o.order.removeMemberInfo()}catch(i){}},applyMemberInfo:function(e){if(void 0!==o.order.myMemberInfo){if(e===!0)return o.order.member.mb_cash(o.order.myMemberInfo.mb_cash),o.order.member.dsp_cash(0),void 0;console.log(o.order.myMemberInfo);var t=null;for(var r in o.order.member)"mb_cash"!==r&&"dsp_cash"!==r&&"mergeMbHp"!==r&&o.order.member[r](o.order.myMemberInfo[r]);try{t=o.order.myMemberInfo.mb_hp.split("-")}catch(n){}3===t.length&&(o.order.member.mb_hp0(t[0]),o.order.member.mb_hp1(t[1]),o.order.member.mb_hp2(t[2]))}},removeMemberInfo:function(){if(void 0!==this.myMemberInfo)for(var e in o.order.member)"mb_cash"!==e&&"dsp_cash"!==e&&this.member[e]("")},caQtyChange:function(t,r){try{{e(r.target)}o.order.copyItemsToOrderInfo()}catch(n){}},deleteCartItem:function(t,r){if(void 0!==r)try{if(confirm("선택한 내역을 삭제 하시겠습니까?")===!0){var n=o.order.jqFormCartList,i=0,d={order_type:"del"},a="";this.odata.remove(function(e){var o=e.it_checked();return o===!0&&(a+=0===i?e.ca_id():","+e.ca_id(),i++),o===!0}),d.ca_id=a,console.log(d),e.post(n.attr("action"),d,function(e){console.log(e)}),o.order.odata().length<1&&o.order.hideInfo(),o.order.copyItemsToOrderInfo()}}catch(c){}},setData:function(t){o.order.odata.removeAll(),void 0!==t.order&&t.order.length>0&&o.order.od_id(t.order[0].od_id),t.order&&e.map(t.order,function(e){o.order.odata.push(new m.setOdata(e))}),o.order.initMemberInfo()},load:function(t,r){var n={};return void 0!==t?(o.order.setData(t),void 0):(e.getJSON("/mobile/mb/order.php",n,function(e){console.log(e.order),o.order.setData(e),void 0!==r&&r()}).fail(function(e,o,t){console.log(t),console.log(e),console.log(o),alert("에러가 발생하였습니다")}),void 0)},isVisible:function(){return e("#container_orderView").hasClass("active-view")},show:function(e){o.order.isBuy(e===!0),e===!0?o.order.showInfo():o.order.hideInfo(),m.slideLeft(".active-view","#container_orderView")},hide:function(){m.slidePrev()},showWithInfo:function(){o.order.show(!0)},showInfo:function(){o.order.copyItemsToOrderInfo(),o.order.odata().length>0?this.jqFormCartList.parent().next().show():e("#list_cart").tooltip("show"),o.order.onInfoShown()},hideInfo:function(){this.jqFormCartList.parent().next().hide()},onCartItemChanged:function(){o.order.copyItemsToOrderInfo()},evt_infoshown:null,infoshown:function(e){this.evt_infoshown=e},onInfoShown:function(){try{this.evt_infoshown()}catch(e){}}},o.zipcode={list:t.observableArray(),init:function(){e("#form_searchZipcode").submit(function(){var t=e(this),r=t.serialize();return e.getJSON(t.attr("action"),r,function(t){o.zipcode.list.removeAll(),console.log(t),e.map(t,function(e){o.zipcode.list.push(e)})}),!1}),e("#modal_zipcode").on("shown.bs.modal",function(){var o=e("#form_searchZipcode input[name='addr1']");o[0].focus()}),e("#button_searchZipcode").click(function(){var t=e("#form_searchZipcode input[name='addr1']");t.val(""),o.zipcode.list.removeAll()})},getCount:t.computed(function(){try{return o.zipcode.list().length}catch(e){return 0}}),evt_selected:[],selected:function(e){this.evt_selected.push(e)},onselected:function(t,r){if(void 0!==t)try{var n=e(r.target),i=o.zipcode.evt_selected.length;"A"!==n.prop("tagName")&&(n=n.parent());try{for(var d=0;i>d;d++)o.zipcode.evt_selected[d](t)}catch(a){}}catch(a){}}},o.order.init(),o.zipcode.init()}function n(){for(var o=this,r=m.OrderDataProps,n=r.length,i=0;n>i;i++)"it_names"!==r[i]&&"it_settle_price"!==r[i]&&(o[r[i]]=t.observable(""));o.od_coupon(0),o.od_delivery(e.tryParseInt(o.od_delivery())),o.it_checked=t.observable(!0),o.it_names=t.observableArray(),o.it_settle_price=t.computed(function(){return e.tryParseInt(o.it_price())*e.tryParseInt(o.ca_qty())})}function i(o){for(var r=this,n=m.OrderDataProps,i=n.length,d=null,a=0;i>a;a++)"it_names"!==n[a]?"ca_qty"!==n[a]?"it_settle_price"!==n[a]&&(r[n[a]]=t.observable(o[n[a]])):r.ca_qty=""===o.ca_qty||parseInt(o.ca_qty)<1?t.observable(1):t.observable(o.ca_qty):(r.it_names=t.observableArray(),d=o.it_names,d&&e.map(d,function(e){r.it_names.push(e)}));r.od_delivery(e.tryParseInt(r.od_delivery())),r.it_checked=t.observable(!0),r.it_settle_price=t.computed(function(){return e.tryParseInt(r.it_price())*e.tryParseInt(r.ca_qty())})}function d(e){var o=this;for(var r in e)o[r]=t.observable(e[r])}function a(o){var r=this,n=["mb_name","mb_zip1","mb_zip2","mb_addr1","mb_addr2","mb_tel0","mb_tel1","mb_tel2","mb_hp","mb_email","mb_cash","mb_9"],i=n.length,d=null;if(o)for(var a=0;i>a;a++)r[n[a]]=t.observable(o[n[a]]);else for(var a=0;i>a;a++)r[n[a]]=t.observable("");r.mb_id=t.observable(m.mb_id),r.dsp_coupon=t.observable(0),r.mb_cash(e.tryParseInt(r.mb_cash())),r.dsp_cash=t.observable("");try{d=o.mb_hp.split("-"),console.log(d)}catch(c){}o&&3===d.length?(r.mb_hp0=t.observable(d[0]),r.mb_hp1=t.observable(d[1]),r.mb_hp2=t.observable(d[2])):(r.mb_hp0=t.observable(""),r.mb_hp1=t.observable(""),r.mb_hp2=t.observable("")),r.mergeMbHp=t.computed(function(){return m.mergePhoneInfo([r.mb_hp0(),r.mb_hp1(),r.mb_hp2()])})}function c(e){var o=this,r=["cp_cnt","cp_datetime","cp_doc","cp_end_days","cp_id","cp_img_type","cp_item_use","cp_max_price","cp_name","cp_pass_type","cp_period_days","cp_period_edate","cp_period_sdate","cp_period_use","cp_price","cp_price_type","cp_type","id","mc_date"],n=r.length;if(e){for(var i=0;n>i;i++)o[r[i]]=t.observable(e[r[i]]);o.cp_id_val=e.cp_id}else for(var i=0;n>i;i++)o[r[i]]=t.observable("");o.cp_price_result=t.observable(0),o.set=function(e){if(e)for(var t=0;n>t;t++)o[r[t]](e[r[t]]());else for(var t=0;n>t;t++)o[r[t]](null)}}r.prototype=new m.BaseViewModel,r.prototype.constructor=r,m.OrderModel=r,m.OrderDataProps=["authdata","ca_id","ca_qty","ca_status","ca_status2","cat_id","d_status","de_id","e_date","ex_price","it_cash","it_coupon","it_coupon_use","it_cp","it_delivery","it_delivery_use","it_enuri","it_id","it_name","it_names","it_opt","it_price","it_res_price","it_settle_price","it_type","life_e_date","life_s_date","mb_id","od_admin_memo","od_b_addr1","od_b_addr2","od_b_hp","od_b_name","od_b_tel","od_b_zip1","od_b_zip2","od_bank_date","od_bank_use","od_cash","od_cashreceiptyn","od_chk_datetime","od_coupon","od_coupon_id","od_coupon_use","od_cp","od_d_status","od_datetime","od_delivery","od_delivery_use","od_deposit_name","od_email","od_enuri","od_escrow_no","od_escrow_use","od_hp","od_id","od_invoice","od_invoice_time","od_memo","od_name","od_password","od_reserve","od_s_status","od_settle_log","od_settle_price","od_settle_use","od_status","od_status2","od_tel","od_tid","od_total_price","pa_ca_id","pause_cnt","pause_day","pause_state","s_date","s_status","site","stock_use","tax_use","tempOLDorderID","tempOLDordergoodsID","update_datetime","update_mb_id"],m.Odata=n,m.setOdata=i,m.setZipcode=d,m.setMember=a,m.setCoupon=c});